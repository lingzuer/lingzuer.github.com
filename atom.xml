<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[北武灵尊]]></title>
  <link href="http://lingzuer.github.io/atom.xml" rel="self"/>
  <link href="http://lingzuer.github.io/"/>
  <updated>2015-01-31T21:42:39+08:00</updated>
  <id>http://lingzuer.github.io/</id>
  <author>
    <name><![CDATA[lingzuer]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[XCTest测试属性变化]]></title>
    <link href="http://lingzuer.github.io/blog/2015/01/31/xctestce-shi-shu-xing-bian-hua/"/>
    <updated>2015-01-31T21:01:07+08:00</updated>
    <id>http://lingzuer.github.io/blog/2015/01/31/xctestce-shi-shu-xing-bian-hua</id>
    <content type="html"><![CDATA[<p>之前有一篇写XCTest异步测试，现在写一下对属性值变化的测试。比如设置某个属性的值，然后调用了某个方法后，值的变化是不是我们预期得到的。下面的代码是作者jtang写的，我修改了一句以适应ARC模式。</p>

<p>1、创建一个NSObject的扩展类(Category)</p>

<p>NSObject+Properties.h</p>

<pre><code>#import &lt;Foundation/Foundation.h&gt;

@interface NSObject (Properties)

// 仅可用于单元测试 ivarName是成员变量名字,不是属性名字
// 对于对象直接返回,如果是原始数据类型.返回NSValue
// 示例:
// NSValue *value = [self getIvarFromString_ONLY_USE_IN_UNIT_TEST:@"_test"];
// int x;
// [value getValue:&amp;x];
- (id)getIvarFromString_ONLY_USE_IN_UNIT_TEST:(NSString *)ivarName;

@end
</code></pre>

<p>NSObject+Properties.m</p>

<pre><code>#import "NSObject+Properties.h"
#import &lt;objc/runtime.h&gt;

@implementation NSObject (Properties)

- (id)getIvarFromString_ONLY_USE_IN_UNIT_TEST:(NSString *)ivarName
{

    Ivar ivar = class_getInstanceVariable(self.class, [ivarName UTF8String]);
    //    Ivar ivar = object_getInstanceVariable(self, [ivarName UTF8String], NULL);

    if (ivar)
    {
        id ivarID = object_getIvar(self, ivar);
        const char *typeEncoding = ivar_getTypeEncoding(ivar);
        if (typeEncoding[0] == '@')
        {
            return ivarID;
        }
        else
        {
            return [NSValue valueWithBytes:&amp;ivarID objCType:typeEncoding];
        }
    }

    return nil;
}

@end
</code></pre>

<p>2、用法举例</p>

<p>ViewController.h</p>

<pre><code>#import &lt;UIKit/UIKit.h&gt;

@interface ViewController : UIViewController

- (void)test;

@end
</code></pre>

<p>ViewController.m</p>

<pre><code>#import "ViewController.h"

@interface ViewController ()

@property (nonatomic, strong) NSString *userName;

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view, typically from a nib.
    _userName = @"abc";
}

- (void)test {
    _userName = @"def";
}

@end
</code></pre>

<p>测试文件MyAppTests.m</p>

<pre><code>#import &lt;UIKit/UIKit.h&gt;
#import &lt;XCTest/XCTest.h&gt;
#import "ViewController.h"
#import "NSObject+Properties.h"

@interface MyAppTests : XCTestCase {
    // add instance variables to the CalcTests class

    ViewController  *viewController;
}

@end

@implementation MyAppTests

- (void)setUp {
    [super setUp];
    // Put setup code here. This method is called before the invocation of each test method in the class.
    viewController = [[ViewController alloc] init];
}

- (void)tearDown {
    // Put teardown code here. This method is called after the invocation of each test method in the class.
    [super tearDown];

}

- (void)testUserName {
    [viewController test];
    NSString *userName = (NSString *)[viewController getIvarFromString_ONLY_USE_IN_UNIT_TEST:@"_userName"];
    XCTAssertEqualObjects(userName, @"def", @"Sussess");
}

@end
</code></pre>

<p>3、测试UI变化</p>

<pre><code>#import "TestSettingPickerCell_UI.h"
#import "SettingPickerCell.h"
#import "NSObject+Properties.h"

@implementation TestSettingPickerCell_UI
{
    SettingPickerCell *cell;
}


- (void)testsetCheckMarkYES
{
    UIImageView *checkImageView = [cell getIvarFromString_ONLY_USE_IN_UNIT_TEST:@"_mCheckImageView"];
    [cell setCheckMark:YES];
    STAssertEquals(checkImageView.image, [UIImage imageNamed:@"selected_green.png"],@"");
}

- (void)testsetCheckMarNO
{
    UIImageView *checkImageView = [cell getIvarFromString_ONLY_USE_IN_UNIT_TEST:@"_mCheckImageView"];
    [cell setCheckMark:NO];
    STAssertEquals(checkImageView.image, [UIImage imageNamed:@"CellUnchecked.png"],@"");
}

- (void)setUp
{
    [super setUp];
    cell = [[SettingPickerCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@"cell"];
}

- (void)tearDown
{
    [super tearDown];
}

@end
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[积累的脚本]]></title>
    <link href="http://lingzuer.github.io/blog/2015/01/30/ji-lei-de-jiao-ben/"/>
    <updated>2015-01-30T22:06:38+08:00</updated>
    <id>http://lingzuer.github.io/blog/2015/01/30/ji-lei-de-jiao-ben</id>
    <content type="html"><![CDATA[<p>自己常用的一些脚本，批量查找、替换、删除。</p>

<p>1、复制一个文件夹下的文件到另外一个文件夹下</p>

<pre><code>cp -ri bar/ foo/
</code></pre>

<p>2、删除文件夹下的文件</p>

<pre><code>rm -rf /images/image*
</code></pre>

<p>3、在文件中查找关键字并替换</p>

<pre><code>grep -rl "2013 - 浙ICP备" * | xargs sed -i -e 's/2013 - 浙ICP备/2013-2014 - 浙ICP备/g'
</code></pre>

<p>4、查找文件夹下的文件是否包含某个关键字</p>

<pre><code>find src/ -name *.html |xargs grep -rn "火影"

find classes/ -name '*.xib' -o -name '*.mm' -o -name '*.m' |xargs grep -rl "bg_picker_white_cell" 

find src/ -name *.js |xargs grep -rn "__dirty__"
</code></pre>

<p>5、批量替换的脚本</p>

<pre><code>#!/bin/sh
#批量替换文案

oldString='&lt;a target="_blank" href="http://yixin.im/contact.html"&gt;联系我们&lt;/a&gt;'
newString='&lt;a target="_blank" href="http://yixin.im/contact.html"&gt;联系我们&lt;/a&gt; - &lt;a target="_blank" href="http://yixin.im/contact.html"&gt;扫黄打非·净网2014&lt;/a&gt;'

grep -rl $oldString *.html | xargs sed -i -e "s#$oldString#$newString#g"
</code></pre>

<p>6、删除example文件所有包含test的行</p>

<pre><code>sed '/test/d' example
</code></pre>

<p>7、删除文件夹下文件中还有console.log的行，并且删除Sublime Text产生的-e结尾的文件</p>

<pre><code>find html/ -name *.html -o -name *.js | xargs sed -i -e '/console.log/d'
find javascript/ -name *.html -o -name *.js | xargs sed -i -e '/console.log/d'

find src/ -name "*.html-e" -o -name "*.js-e" | xargs rm -f
</code></pre>

<p>这个脚本的产生是有个缘由的，一个有奖（大奖有iPhone6 plus）的活动页面，查看页面源代码的时候，虽然js代码经过了压缩并混淆，但是文件中的console.log中写的中文都显示出来了，要命的是，console.log中把每一个步骤及逻辑都写在里面了。幸亏是在公司内测的时候发现的问题。</p>

<p><img src="http://lingzuer.github.io/images/blog/console-log-1.jpg" alt="console log" /></p>

<p><img src="http://lingzuer.github.io/images/blog/console-log-2.jpg" alt="console log" /></p>

<p>然后我就想怎么把所有的console.log干掉，然后再压缩混淆，于是就有了这个脚本。但是问题来了，console.log在本地调试的时候还是有用的（Native+Web的方式，<a href="https://www.npmjs.com/package/weinre">weinre</a>调试方便一点），总不能先运行脚本删掉，然后等打包发布完了，再revert回来吧，于是就想，能不能在打包脚本里面加上去掉console.log的功能呢，正好看了一下公司的打包脚本是<a href="https://github.com/mishoo/UglifyJS2">Uglifyjs2</a>，继续上网查找资料的时候，发现Uglifyjs2有去掉console.log的配置项，drop_console: true，然后联系了NEJ作者genify，大牛百忙中加上了这个<a href="https://github.com/genify/toolkit/commit/39e6faaae26e2f6efc744bfd79278a00e65bd729">配置</a>，工程在这里<a href="https://github.com/genify/toolkit">https://github.com/genify/toolkit</a>，顺利打包。</p>

<p>8、find的时候排除某个文件夹</p>

<p>文件结构：</p>

<pre><code>Demo
 | ——— First
       | ——— One
             | ——— index.html
 | ——— Second
       | ——— index.html
 | ——— index.html
</code></pre>

<p>1)、在Demo文件夹下查找index.html，排除Second文件夹</p>

<pre><code>find . -path './Second' -prune -o -name '*.html' -print
</code></pre>

<p>2)、在Demo文件夹下查找index.html，排除One文件夹</p>

<pre><code>find . -path './First/One' -prune -o -name '*.html' -print
</code></pre>

<p>3)、-prune对前面求值，-print不能少</p>

<p>这个脚本有什么具体的使用呢？这是我后来看到<a href="https://github.com/jeffhodnett/Unused">Unused</a>的时候想到的，这个项目有个问题，一是没有处理@3x的图片，作者很久都没有更新过了，另外一个就是跑出来的结果中，有个文件夹下面是我不想让它去检索的，比如存放Emoji表情的文件夹，那我就想，能不能也提供个输入框，用来选择要过滤的某个文件夹呢，然后一番尝试，还真成功了，哈哈，起作用的主要代码如下：</p>

<pre><code>// Create a find task
NSTask *task = [[[NSTask alloc] init] autorelease];
[task setLaunchPath: @"/usr/bin/find"];

// Search for all png files
NSArray *argvals = nil;
if (filterDirectoryPath.length &lt;= 0) {
    argvals = [NSArray arrayWithObjects:directoryPath, @"-name", @"*.png", nil];
} else {
    argvals = [NSArray arrayWithObjects:directoryPath,
                        @"-path", filterDirectoryPath, @"-prune", @"-o", @"-name", @"*.png", @"-print", nil];
}

[task setArguments: argvals];
</code></pre>

<p>这是过滤了一个文件夹，要是过滤好几个呢，那就是：</p>

<pre><code>find ./ \( -path './dir0*' -o -path './dir1*' \) -a -prune -o -name '*.png' -print
</code></pre>

<p>对这个开源项目改造了一下，试跑了一下易信的工程，运行时间大大减少，并且还找出了好几个没有用到的图片资源，减少了好几十个kb呢，也算是安慰了一下这颗折腾的心吧。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[XCTest单元测试]]></title>
    <link href="http://lingzuer.github.io/blog/2015/01/29/xctestdan-yuan-ce-shi/"/>
    <updated>2015-01-29T22:14:13+08:00</updated>
    <id>http://lingzuer.github.io/blog/2015/01/29/xctestdan-yuan-ce-shi</id>
    <content type="html"><![CDATA[<p>QA的同事说帮他们讲一下OC，我自己都是个搓鸟，还给别人讲，就当是玩笑拒绝了，那么多大牛都在，找我讲？后来又说让我讲，是认真的，那我想，反正他们也不会，忽悠一下他们还是OK的了，简单的写个Hello World还是不成问题的，于是就去讲了，讲到后来才明白他们想的最终需求是：单元测试。作为开发我从来没有了解过这一块，我说自己回去先写个Demo。于是上网各种搜索，还是有些收获的，昨天晚上到12:40，对UI和属性的测试有了点思路，完成一个简单的Demo，就当是单元测试的Hello World吧，今天上午又搞定了异步请求的单元测试，结合自己项目（方便写登录的请求）写了一个Demo，这也是列为今天todo list的第一个任务。现在记录一下。</p>

<p>1、新建一个测试的Target</p>

<p><img src="http://lingzuer.github.io/images/blog/test-target.png" alt="Test Target" /></p>

<p>2、设置Search Paths
保持和项目的Target设置一致，不然在引用文件的时候，可能会提示有些文件找不到，比如：LoginManager.h:10:9: fatal error: &lsquo;biz/service/auth/auth_protocol.h&rsquo; file not found</p>

<p><img src="http://lingzuer.github.io/images/blog/search-paths.png" alt="Search Paths" /></p>

<p>3、新建Test Class</p>

<p>见图一。</p>

<p>4、引入需要的文件开始测试
比如要写一个登录的单元测试，那要引入LoginManager.h之类的文件吧，我大概写一下，有些是项目的代码，不知道写在博文里面好不好。</p>

<pre><code>#import &lt;UIKit/UIKit.h&gt;
#import &lt;XCTest/XCTest.h&gt;
#import "LoginManager.h"
#import "LoginCallBack.h"

@interface MyTests : XCTestCase {
    XCTestExpectation *_expectation;
}

@end

@implementation MyTests

- (void)setUp {
    [super setUp];
    [self addListenEvents];
}

- (void)tearDown {
    [self removeListenEvents];
    [super tearDown];
}

#pragma mark - 通知
- (void)addListenEvents {
    extern NSString *kYIXINNotificationLoginResult;
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(onGetLoginResult:) name:kYIXINNotificationLoginResult object:nil];
}

- (void)removeListenEvents {
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}

#pragma mark - Test Methods
- (void)testUserLogin {
    _expectation = [self expectationWithDescription:@"Login request"];

    NSString *username = @"userID";
    NSString *password = @"111111";

    [LoginManager sharedManager].currentLoginData.userName = username;
    [LoginManager sharedManager].currentLoginData.userPassword = [XXUtil encytePassword:password];
    [LoginManager sharedManager].currentLoginData.type = kAccountYid;

    [[LoginManager sharedManager] beginLogin];

    [self waitForExpectationsWithTimeout:5
                             handler:^(NSError *error) {
                                 // handler is called on _either_ success or failure
                                 if (error != nil) {
                                     XCTFail(@"timeout error: %@", error);
                                 }
                             }];
}


#pragma mark - LoginResultProtocol
- (void)onGetLoginResult:(NSNotification*)aNotification {
    extern NSString *kLoginStepKey;
    extern NSString *kLoginResultKey;

    NSDictionary *data  = aNotification.userInfo;
    NSInteger step      = [[data objectForKey:kLoginStepKey] intValue];
    NSInteger errorCode = [[data objectForKey:kLoginResultKey] intValue];

    if (step == kLoginStepLogin) {
        [_expectation fulfill];
        if (errorCode == kResSuccess) {
            XCTAssert(YES, @"Pass");
        } else {
            XCTAssert(NO, @"No Pass");
        }
    } else {
        NSLog(@ "login result: step is %@, code is %@",@(step), @(errorCode));
    }
}

@end
</code></pre>

<p>5、异步测试要点</p>

<pre><code>_expectation = [self expectationWithDescription:@"Login request”];
[_expectation fulfill];
XCTAssert(YES, @"Pass");
</code></pre>

<p>6、其他</p>

<p>其他的异步测试比如Block、Delegate的方式也都如此(采用XCTestExpectation)。</p>

<p>7、参考资料</p>

<ul>
<li><a href="http://objccn.io/issue-15-2/">http://objccn.io/issue-15-2/</a></li>
<li><a href="http://www.objc.io/issue-15/xctest.html">http://www.objc.io/issue-15/xctest.html</a></li>
<li><a href="http://www.bignerdranch.com/blog/asynchronous-testing-with-xcode-6/">http://www.bignerdranch.com/blog/asynchronous-testing-with-xcode-6/</a></li>
<li><a href="http://blog.dadabeatnik.com/2014/07/13/asynchronous-unit-testing-in-xcode-6/">http://blog.dadabeatnik.com/2014/07/13/asynchronous-unit-testing-in-xcode-6/</a></li>
<li><a href="http://www.pumpmybicep.com/2014/08/22/objective-c-http-stubbing-libraries/">http://www.pumpmybicep.com/2014/08/22/objective-c-http-stubbing-libraries/</a></li>
<li><a href="http://iosunittesting.com/asynchronous-tests-using-xctestexpectation/">http://iosunittesting.com/asynchronous-tests-using-xctestexpectation/</a></li>
<li><a href="http://www.pumpmybicep.com/2014/08/20/asynchronous-unit-testing-with-xctest/">http://www.pumpmybicep.com/2014/08/20/asynchronous-unit-testing-with-xctest/</a></li>
<li><a href="http://nshipster.com/xctestcase/">http://nshipster.com/xctestcase/</a></li>
<li><a href="http://ocmock.org">http://ocmock.org</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hello to Myself]]></title>
    <link href="http://lingzuer.github.io/blog/2015/01/28/hello-to-myself/"/>
    <updated>2015-01-28T15:17:17+08:00</updated>
    <id>http://lingzuer.github.io/blog/2015/01/28/hello-to-myself</id>
    <content type="html"><![CDATA[<p>Octopress听到它有些时间了，并且还配置好Run成功了，甚至有个Hello World的一个博文，我看了提交记录是Aug 14, 2013。从这之后就放着了，因为不知道写什么。再后来，看很多大牛写博客，然后就自己也想写，有个幼稚的想法是：大牛要写博客，写博客会成为大牛。</p>

<p>仔细想想写什么东西呢？写的东西给谁看呢？好累，现在想通了，我的博客定位就是自己记录一下自己学到的知识点，以前不知道的，现在知道了，记录下来，下次再想查的时候，方便一点儿，于是就下定决心想要写了。</p>

<p>这个时候已经换了一台电脑了，又要重新折腾Octopress，在一步一步配置的时候，出现问题了，没有Run成功，于是又放下了，第二天又尝试了一次，又没有成功，就又放下了，如此反复几次后，暗暗的下了一个决心：一定要Run起来，不然会对以后的修行有障碍（凡人修仙）。</p>

<p>花了一整天时间上网查找资料，功夫不负有心人，折腾到下午的时候，突然一个尝试了一个方法，结果成功了。心里特别开心，觉得只要下死功夫没有搞不定的。</p>

<p>环境搞好了，又陷入了脑海（脑子里的一片独特空间，这个地方不断有新想法冒出来）中，第一篇写点什么呢，写的不好怎么办呢？就又放了有一个月。</p>

<p>而后在反思自己为什么总有一些想法（养鱼、养花、打羽毛球，还有很多）冒出来，却都没有实施的时候，突然诊断出自己又一个到了晚期的心理病：拖延症，严重的拖延症。</p>

<p>症状表现是：总是在想，从来没有实施。自己的脑海里面有N个idea，每个idea都是那么的美好（老婆说很多都不切实际），当想实施的时候，发现有许许多多的条件不满足，即使做了，也达不到预期的美好效果，然后就放弃了，开始下一个胡思乱想。可能还有个原因就是，想做到最好，所以没有开始做。</p>

<p>这让我心里有些害怕，我从什么时候变成这样，或者一直是这样，一直没有发现么。</p>

<p>我想改变，哪怕是做一点很小的事情或者举动（比如一直在脑海里做俯卧撑，这个时候身体实施了一个俯卧撑动作），只要不是光想着的就行。</p>

<p>这样有了这一篇博文，我想写，我写了。</p>
]]></content>
  </entry>
  
</feed>
